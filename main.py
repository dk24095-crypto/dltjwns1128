import streamlit as st
import pandas as pd
import altair as alt

# --------------------------------------
# ê¸°ë³¸ ì„¤ì •
# --------------------------------------
st.set_page_config(page_title="êµ­ë¯¼ì—°ê¸ˆ íˆ¬ì ë¶„ì„", layout="wide")

st.title("ğŸ’¹ êµ­ë¯¼ì—°ê¸ˆ êµ­ë‚´ì£¼ì‹ íˆ¬ì ë¶„ì„")
st.markdown("""
ì´ ì•±ì€ **êµ­ë¯¼ì—°ê¸ˆê³µë‹¨ì˜ êµ­ë‚´ì£¼ì‹ íˆ¬ì ë°ì´í„°**ë¥¼ ë°”íƒ•ìœ¼ë¡œ  
`í‰ê°€ì•¡(ì–µ ì›)`ê³¼ `ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)`ì˜ ê´€ê³„ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
""")

# --------------------------------------
# íŒŒì¼ ì—…ë¡œë“œ
# --------------------------------------
uploaded_file = st.file_uploader("CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["csv"])

if uploaded_file is not None:
    # ì¸ì½”ë”© ìë™ ì²˜ë¦¬
    try:
        df = pd.read_csv(uploaded_file, encoding="cp949")
    except:
        df = pd.read_csv(uploaded_file, encoding="utf-8-sig")

    # ë°ì´í„° í™•ì¸
    st.subheader("ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
    st.dataframe(df.head())

    # ìˆ«ìí˜• ì»¬ëŸ¼ ë³€í™˜
    df["í‰ê°€ì•¡(ì–µ ì›)"] = pd.to_numeric(df["í‰ê°€ì•¡(ì–µ ì›)"], errors="coerce")
    df["ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"] = pd.to_numeric(df["ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"], errors="coerce")
    df = df.dropna(subset=["í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"])

    # --------------------------------------
    # ê¸°ë³¸ í†µê³„
    # --------------------------------------
    st.subheader("ê¸°ì´ˆ í†µê³„ ìš”ì•½")
    col1, col2, col3 = st.columns(3)
    col1.metric("í‰ê·  í‰ê°€ì•¡(ì–µ ì›)", f"{df['í‰ê°€ì•¡(ì–µ ì›)'].mean():,.1f}")
    col2.metric("í‰ê·  ì§€ë¶„ìœ¨(%)", f"{df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)'].mean():.2f}")
    col3.metric("ìƒê´€ê³„ìˆ˜", f"{df['í‰ê°€ì•¡(ì–µ ì›)'].corr(df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)']):.3f}")

    # --------------------------------------
    # Altair ì‹œê°í™”
    # --------------------------------------
    st.subheader("í‰ê°€ì•¡ê³¼ ì§€ë¶„ìœ¨ì˜ ê´€ê³„ ì‹œê°í™”")

    max_value = st.slider(
        "ìµœëŒ€ í‰ê°€ì•¡(ì–µ ì›) í•„í„°",
        min_value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].min()),
        max_value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].max()),
        value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].quantile(0.95))
    )

    filtered = df[df["í‰ê°€ì•¡(ì–µ ì›)"] <= max_value]

    # ì‚°ì ë„
    scatter = (
        alt.Chart(filtered)
        .mark_circle(size=60, opacity=0.7)
        .encode(
            x=alt.X("í‰ê°€ì•¡(ì–µ ì›):Q", title="í‰ê°€ì•¡ (ì–µ ì›)", scale=alt.Scale(zero=False)),
            y=alt.Y("ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸):Q", title="ì§€ë¶„ìœ¨ (%)", scale=alt.Scale(zero=False)),
            tooltip=["ì¢…ëª©ëª…", "í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"]
        )
    )

    # íšŒê·€ì„ 
    regression_line = (
        alt.Chart(filtered)
        .transform_regression("í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)")
        .mark_line(color="red", strokeWidth=2)
    )

    # ë‘ ê·¸ë˜í”„ë¥¼ layerë¡œ ê²°í•©
    chart = alt.layer(scatter, regression_line).interactive()

    st.altair_chart(chart, use_container_width=True)

    # --------------------------------------
    # ë¶„ì„ ìš”ì•½
    # --------------------------------------
    st.markdown("### ğŸ” ë¶„ì„ ìš”ì•½")
    st.write(f"""
    - ë°ì´í„° ê°œìˆ˜: **{len(df):,}ê°œ ì¢…ëª©**
    - í‰ê°€ì•¡ ìƒìœ„ 10ê°œ ì¢…ëª© í‰ê·  ì§€ë¶„ìœ¨: **{df.nlargest(10, 'í‰ê°€ì•¡(ì–µ ì›)')['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)'].mean():.2f}%**
    - ì „ì²´ ìƒê´€ê´€ê³„: **{df['í‰ê°€ì•¡(ì–µ ì›)'].corr(df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)']):.3f}**
    """)
    st.markdown("> ë¹¨ê°„ ì„ ì€ ë‹¨ìˆœ ì„ í˜• íšŒê·€ì„ ìœ¼ë¡œ, í‰ê°€ì•¡ì´ ë†’ì„ìˆ˜ë¡ ì§€ë¶„ìœ¨ì´ ì¦ê°€í•˜ëŠ” ê²½í–¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

else:
    st.info("ğŸ‘† CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")
