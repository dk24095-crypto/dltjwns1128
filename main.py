import streamlit as st
import pandas as pd
import altair as alt

# --------------------------------------
# ğŸ¯ ê¸°ë³¸ ì„¤ì •
# --------------------------------------
st.set_page_config(page_title="êµ­ë¯¼ì—°ê¸ˆ íˆ¬ì ë¶„ì„", layout="wide")

st.title("ğŸ’¹ êµ­ë¯¼ì—°ê¸ˆ êµ­ë‚´ì£¼ì‹ íˆ¬ì ë¶„ì„")
st.markdown("""
ì´ ì•±ì€ **êµ­ë¯¼ì—°ê¸ˆê³µë‹¨ì˜ êµ­ë‚´ì£¼ì‹ íˆ¬ì ë°ì´í„°**ë¥¼ ë°”íƒ•ìœ¼ë¡œ  
`í‰ê°€ì•¡(ì–µ ì›)`ê³¼ `ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)`ì˜ ê´€ê³„ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
""")

# --------------------------------------
# ğŸ“‚ CSV ì—…ë¡œë“œ
# --------------------------------------
uploaded_file = st.file_uploader("CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=["csv"])

if uploaded_file is not None:
    try:
        # í•œêµ­ì–´ CSVëŠ” CP949 ì¸ì½”ë”©ìœ¼ë¡œ ì½ê¸°
        df = pd.read_csv(uploaded_file, encoding="cp949")
    except:
        # í˜¹ì‹œ ëª¨ë¥¼ UTF-8 BOM ëŒ€ì‘
        df = pd.read_csv(uploaded_file, encoding="utf-8-sig")

    # --------------------------------------
    # ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
    # --------------------------------------
    st.subheader("ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
    st.dataframe(df.head())

    # ì»¬ëŸ¼ëª… ìë™ ì¸ì‹
    cols = df.columns
    st.markdown(f"**ì»¬ëŸ¼ëª…:** {', '.join(cols)}")

    # ìˆ«ìí˜• ì»¬ëŸ¼ë§Œ ê³¨ë¼ íƒ€ì… ë³€í™˜ ì‹œë„
    df["í‰ê°€ì•¡(ì–µ ì›)"] = pd.to_numeric(df["í‰ê°€ì•¡(ì–µ ì›)"], errors="coerce")
    df["ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"] = pd.to_numeric(df["ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"], errors="coerce")
    df = df.dropna(subset=["í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"])

    # --------------------------------------
    # ğŸ“Š ê¸°ë³¸ í†µê³„
    # --------------------------------------
    st.subheader("ê¸°ì´ˆ í†µê³„ ìš”ì•½")
    col1, col2, col3 = st.columns(3)
    col1.metric("í‰ê·  í‰ê°€ì•¡(ì–µ ì›)", f"{df['í‰ê°€ì•¡(ì–µ ì›)'].mean():,.1f}")
    col2.metric("í‰ê·  ì§€ë¶„ìœ¨(%)", f"{df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)'].mean():.2f}")
    col3.metric("ìƒê´€ê³„ìˆ˜", f"{df['í‰ê°€ì•¡(ì–µ ì›)'].corr(df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)']):.3f}")

    # --------------------------------------
    # ğŸ“ˆ Altair ì‹œê°í™”
    # --------------------------------------
    st.subheader("í‰ê°€ì•¡ê³¼ ì§€ë¶„ìœ¨ì˜ ê´€ê³„ ì‹œê°í™”")

    # ê°’ ì¡°ì • ìŠ¬ë¼ì´ë” (ì´ìƒì¹˜ ì œê±°ìš©)
    max_value = st.slider("ìµœëŒ€ í‰ê°€ì•¡(ì–µ ì›) í•„í„°", 
                          min_value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].min()), 
                          max_value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].max()), 
                          value=float(df["í‰ê°€ì•¡(ì–µ ì›)"].quantile(0.95)))

    filtered = df[df["í‰ê°€ì•¡(ì–µ ì›)"] <= max_value]

    # Altair ì°¨íŠ¸ êµ¬ì„±
    scatter_chart = (
        alt.Chart(filtered)
        .mark_circle(size=60, opacity=0.7)
        .encode(
            x=alt.X("í‰ê°€ì•¡(ì–µ ì›):Q", title="í‰ê°€ì•¡ (ì–µ ì›)", scale=alt.Scale(zero=False)),
            y=alt.Y("ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸):Q", title="ì§€ë¶„ìœ¨ (%)", scale=alt.Scale(zero=False)),
            tooltip=["ì¢…ëª©ëª…", "í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)"]
        )
        .interactive()
        .properties(height=500)
        .configure_axis(labelFontSize=12, titleFontSize=13)
    )

    # íšŒê·€ì„  ì¶”ê°€
    regression = (
        scatter_chart
        + scatter_chart.transform_regression("í‰ê°€ì•¡(ì–µ ì›)", "ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)").mark_line(color="red")
    )

    st.altair_chart(regression, use_container_width=True)

    # --------------------------------------
    # ğŸ“‰ ë¶„ì„ ìš”ì•½
    # --------------------------------------
    st.markdown("### ğŸ” ë¶„ì„ ìš”ì•½")
    st.write(f"""
    - ë°ì´í„° ê°œìˆ˜: **{len(df):,}ê°œ ì¢…ëª©**
    - í‰ê°€ì•¡ ìƒìœ„ 10ê°œ ì¢…ëª© í‰ê·  ì§€ë¶„ìœ¨: **{df.nlargest(10, 'í‰ê°€ì•¡(ì–µ ì›)')['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)'].mean():.2f}%**
    - ì „ì²´ ìƒê´€ê´€ê³„: **{df['í‰ê°€ì•¡(ì–µ ì›)'].corr(df['ì§€ë¶„ìœ¨(í¼ì„¼íŠ¸)']):.3f}**
    """)
    st.markdown("> ë¹¨ê°„ ì„ ì€ ë‹¨ìˆœ ì„ í˜• íšŒê·€ì„ ìœ¼ë¡œ, í‰ê°€ì•¡ì´ ë†’ì„ìˆ˜ë¡ ì§€ë¶„ìœ¨ì´ ì¦ê°€í•˜ëŠ” ê²½í–¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
else:
    st.info("ğŸ‘† CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")


